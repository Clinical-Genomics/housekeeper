
{% macro postpone_btn(case_name, run) %}
  {% if run.cleanup_in < 10 %}
    {% if run.cleanup_in < 3 %}
      {% set btn_class = 'btn-danger' %}
    {% else %}
      {% set btn_class = 'btn-warning' %}
    {% endif %}
  {% else %}
    {% set btn_class = 'btn-default' %}
  {% endif %}

  <form action="{{ url_for('case_postpone', case_name=case_name) }}" method="POST" accept-charset="utf-8">
    <button class="btn {{ btn_class }} btn-xs">
      {{ run.cleanup_in }} days
      <span class="glyphicon glyphicon-repeat"></span>
    </button>
  </form>
{% endmacro %}

{% macro runs_table(case=None, cases=None) %}
  <div class="table-responsive">
    <table class="table table-bordered table-hover">
      <thead>
        <tr>
          <th class="col-xs-2">Case</th>
          <th class="col-xs-2">Samples</th>
          <th class="col-xs-2">Pipeline</th>
          <th class="col-xs-1">Analyzed</th>
          <th class="col-xs-1">Delivered</th>
          <th class="col-xs-2">Uploads</th>
          <th class="col-xs-1">Answered out</th>
          <th class="col-xs-1">Archived</th>
          <th class="col-xs-1">Cleaned up</th>
          <th class="col-xs-1">On hold</th>
        </tr>
      </thead>
      <tbody>
        {% if case %}
          {% for run in case.runs %}
            {{ run_row(case, run) }}
          {% endfor %}
        {% elif cases %}
          {% for case in cases %}
            {{ run_row(case, case.current) }}
          {% endfor %}
        {% endif %}
      </tbody>
    </table>
  </div>
{% endmacro %}

{% macro run_row(case, run) %}
  <tr {% if case.has_priority %} class="bg-warning" {% endif %}>
    <td>
      <a href="{{ url_for('case', name=case.name) }}">{{ case.name }}</a>
    </td>
    <td>
      {% for sample in case.samples %}
        <span class="label label-{{ 'success' if sample.sequenced_at else 'default' }}">{{ sample.lims_id }}</span>
      {% endfor %}
    </td>

    {% if run %}
      <td>
        {{ run.pipeline }}
        <span class="badge pull-right">{{ run.pipeline_version }}</span>
      </td>
      <td>{{ run.analyzed_at.date() }}</td>
      <td>{{ run.delivered_at.date() if run.delivered_at }}</td>
      <td>
        {% for column in EXTRA_STATUSES %}
          {% set column_key = "%s_date"|format(column) %}
          {% if run.extra[column_key] %}
            <span class="label label-success">{{ column }}</span>
          {% else %}
            <span class="label label-default">{{ column }}</span>
          {% endif %}
        {% endfor %}
      </td>
      <td>{{ run.answeredout_at.date() if run.answeredout_atÂ }}</td>
      <td>{{ run.archived_at.date() if run.archived_at }}</td>
      <td>
        {% if run.cleanedup_at %}
          {{ run.cleanedup_at }}
        {% else %}
          {{ postpone_btn(case.name, case.current) }}
        {% endif %}
      </td>
      <td>
        <form action="{{ url_for('case_onhold', case_name=case.name) }}" method="POST">
          <button class="btn btn-default btn-sm">
            {{ 'Unpaus' if case.is_onhold else 'Paus' }}
          </button>
        </form>
      </td>
    {% else %}
      <td colspan="7"></td>
    {% endif %}
  </tr>
{% endmacro %}
