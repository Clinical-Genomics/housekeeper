
{% macro postpone_btn(case_name, run) %}
  {% if run.cleanup_in < 10 %}
    {% if run.cleanup_in < 3 %}
      {% set btn_class = 'btn-danger' %}
    {% else %}
      {% set btn_class = 'btn-warning' %}
    {% endif %}
  {% else %}
    {% set btn_class = 'btn-secondary' %}
  {% endif %}

  <form action="{{ url_for('case_postpone', case_name=case_name) }}" method="POST" accept-charset="utf-8">
    <button class="btn {{ btn_class }} btn-sm">
      {{ run.cleanup_in }} days
      <span class="glyphicon glyphicon-repeat"></span>
    </button>
  </form>
{% endmacro %}

{% macro runs_table(case=None, cases=None) %}
  <table class="table table-responsive table-bordered">
    <thead>
      <tr>
        <th class="col-xs-2">Case</th>
        <th class="col-xs-2">Samples</th>
        <th class="col-xs-2">Pipeline</th>
        <th class="col-xs-1">Analyzed</th>
        <th class="col-xs-1">Delivered</th>
        <th class="col-xs-2">Uploads</th>
        <th class="col-xs-1">Answered out</th>
        <th class="col-xs-1">Archived</th>
        <th class="col-xs-1">Cleaned up</th>
        <th class="col-xs-1">On hold</th>
      </tr>
    </thead>
    <tbody>
      {% if case %}
        {% for run in case.runs %}
          {{ run_row(case, run) }}
        {% endfor %}
      {% elif cases %}
        {% for case in cases %}
          {{ run_row(case, case.current) }}
        {% endfor %}
      {% endif %}
    </tbody>
  </table>
{% endmacro %}

{% macro run_row(case, run) %}
  <tr {% if case.has_priority %} class="table-info" {% endif %}>
    <td>
      <a href="{{ url_for('case', name=case.name) }}">{{ case.name }}</a>
      {% if case.is_onhold %}<small class="badge badge-default">PAUSED</small>{% endif %}

      {{ comment_modal(case) }}
    </td>
    <td>
      {% for sample in case.samples %}
        <span class="badge badge-{{ 'success' if sample.sequenced_at else 'default' }}">{{ sample.lims_id }}</span>
      {% endfor %}
    </td>

    {% if run %}
      <td>
        {{ run.pipeline }}
        <span class="badge badge-default pull-right">{{ run.pipeline_version }}</span>
      </td>
      <td>{{ run.analyzed_at.date() }}</td>
      <td>{{ run.delivered_at.date() if run.delivered_at }}</td>
      <td>{{ status_badges(run) }}</td>
      <td>{{ run.answeredout_at.date() if run.answeredout_atÂ }}</td>
      <td>{{ run.archived_at.date() if run.archived_at }}</td>
      <td>
        {% if run.cleanedup_at %}
          {{ run.cleanedup_at }}
        {% else %}
          {{ postpone_btn(case.name, case.current) }}
        {% endif %}
      </td>
    {% else %}
      <td colspan="7"></td>
    {% endif %}
    <td>
      <form action="{{ url_for('case_onhold', case_name=case.name) }}" method="POST">
        <button class="btn btn-secondary btn-sm">
          {{ 'Unpaus' if case.is_onhold else 'Paus' }}
        </button>
      </form>
    </td>
  </tr>
{% endmacro %}

{% macro status_badges(run) %}
  {% for column in EXTRA_STATUSES %}
    {% set column_key = "%s_date"|format(column) %}
    {% if run.extra[column_key] %}
      <span class="badge badge-success mb-1 mr-1">{{ column }}</span>
    {% else %}
      <span class="badge badge-default mb-1 mr-1">{{ column }}</span>
    {% endif %}
  {% endfor %}
{% endmacro %}

{% macro comment_modal(case) %}
  {% set modalId = "comment-%s"|format(case.id) %}

  <!-- Button trigger modal -->
  <button type="button" class="btn btn-{{ 'info' if case.comment else 'secondary' }} btn-sm pull-right" data-toggle="modal" data-target="#{{modalId}}">Comment</button>

  <!-- Modal -->
  <div class="modal fade" id="{{ modalId }}" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
          <h4 class="modal-title">Add comment for {{ case.name }}</h4>
        </div>
        <form action="{{ url_for('comments', case_id=case.id) }}" method="POST">
          <div class="modal-body">
            <div class="form-group">
              <textarea class="form-control" name="comment" cols="30" rows="10">{{ case.comment if case.comment }}</textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary">Save changes</button>
          </div>
        </form>
      </div>
    </div>
  </div>
{% endmacro %}

